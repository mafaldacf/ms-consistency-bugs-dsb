- name: CLIENT_READ_MOVIE_INFO | Prepare clients
  hosts: dsb_mediamicroservices
  become: yes
  vars:
    base_folder_dir: "../../../.."

  tasks:
    - name: Copy read_movie_info.sh file
      copy:
        src: "{{ base_folder_dir }}/scripts/read_movie_info.sh"
        dest: "/home/{{ ansible_user }}/read_movie_info.sh"
        mode: 0755

    - name: Remove previous read_movie_info.log if it exists
      file:
        path: /home/{{ ansible_user }}/read_movie_info.log
        state: absent

- name: CLIENT_READ_MOVIE_INFO | Run clients
  hosts: dsb_mediamicroservices
  become: yes
  vars:
    base_folder_dir: "../../../.."
    timestamp: "{{ hostvars['localhost'].run_ts | default(lookup('pipe','date +%Y%m%d%H%M%S')) }}"

  tasks:
    - name: Run read_movie_info.sh
      shell: |
        /home/{{ ansible_user }}/read_movie_info.sh > /home/{{ ansible_user }}/read_movie_info.log {{ inventory_hostname }} 2>&1
      args:
        executable: /bin/bash

    - name: Fetch read_movie_info.log
      fetch:
        src: /home/{{ ansible_user }}/read_movie_info.log
        dest: "{{ base_folder_dir }}/logs/{{ timestamp }}_exp1_read_movie_info_{{ inventory_hostname }}.log"
        flat: yes
