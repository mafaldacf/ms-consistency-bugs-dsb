- name: CLIENT_REGISTER_MOVIE_IDS | Prepare clients
  hosts: dsb_mediamicroservices
  become: yes
  vars:
    base_folder_dir: "../../../.."

  tasks:
    - name: Copy register_movie_ids.sh file
      copy:
        src: "{{ base_folder_dir }}/scripts/register_movie_ids.sh"
        dest: "/home/{{ ansible_user }}/register_movie_ids.sh"
        mode: 0755

    - name: Remove previous register_movie_ids.log if it exists
      file:
        path: /home/{{ ansible_user }}/register_movie_ids.log
        state: absent

- name: CLIENT_REGISTER_MOVIE_IDS | Run clients
  hosts: dsb_mediamicroservices
  become: yes
  vars:
    base_folder_dir: "../../../.."
    start_unix: "{{ ((ansible_date_time.epoch | int) // 60 + 1) * 60 }}" # next full minute
    timestamp: "{{ hostvars['localhost'].run_ts | default(lookup('pipe','date +%Y%m%d%H%M%S')) }}"

  tasks:
    - name: Convert unix timestamp to datetime on remote host (because of time zones)
      shell: date -d @{{ start_unix }} "+%H:%M %Y-%m-%d"
      register: remote_datetime
      changed_when: false

    - name: Set start_at_datetime from remote conversion
      set_fact:
        start_at_datetime: "{{ remote_datetime.stdout }}"

    - name: Schedule register_movie_ids.sh to run at {{ start_at_datetime }}
      shell: |
        echo '/home/{{ ansible_user }}/register_movie_ids.sh > /home/{{ ansible_user }}/register_movie_ids.log {{ inventory_hostname }} 2>&1' | at '{{ start_at_datetime }}'
      args:
        executable: /bin/bash

    - name: Wait until register_movie_ids.log is created
      wait_for:
        path: /home/{{ ansible_user }}/register_movie_ids.log
        state: present
        timeout: 90
      register: wait_result
      until: wait_result is succeeded
      retries: 3

    - name: Wait 30 seconds to allow finishing requests
      wait_for:
        timeout: 30

    - name: Fetch register_movie_ids.log
      fetch:
        src: /home/{{ ansible_user }}/register_movie_ids.log
        dest: "{{ base_folder_dir }}/logs/{{ timestamp }}_exp3_register_movie_ids_{{ inventory_hostname }}.log"
        flat: yes
